---
title: "Pilgrim Bank Final Report"
author: "Danielle Simms, Jeniffer Lee, Runjie Lu, and Ye Chen"
date: "12/4/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###### The URL for our Team GitHub repository is https://github.com/wonter123/Team-Project-for-BUS-111A.

###### The two lines of code below allows R to read the csv file titled ”PilgrimCaseData” from a specific folder, which was set as the working directory, and allows R to import the csv file into the R environment. This is our dataframe for the assignment.
```{r}
setwd("~/Desktop/Team-Project-for-BUS-111A-master")
pData <- read.csv("PilgrimCaseData.csv")
pcData <- read.csv("PilgrimCaseData.csv")
```
###### It should be noted that the variable name “PcData” contains the original data, and the variable name “PData” is the data after replacing the missing data.

#### Question 1
###### Alan Green, an analyst in Pilgrim Bank’s online banking group, was first called on by his boss, Ravi Raman, because the senior management team needed to determine the future of their Internet Strategy. Due to the fact that there is no data before 1999 about the use of online banking, signifying that there is nothing on which to base future projection of online banking in, in order for management to successfully determine the direction in which they should bring their Internet strategy, customer profitability of customers who use online banking versus those who do not was first determined. 
###### The managerial objective is to shift their strategy to increase customer retention, and, ultimately, customer profitability. In order to do so, they had to determine whether they should charge fees for the use of their online banking channel or if they should begin offering customer incentives such as rebates and lower service charges in order to promote the use of such a channel. However, they first had to determine whether online customers are indeed better customers. Ultimately, the objective is to determine if online banking should be incorporated as part of the banking structure.

#### Question 2
###### ID - Nominal, Profit - Ratio, Online - Nominal, Age - Ordinal, Income Bucket - Ordinal, Tenure - Ratio, District - Nominal , Billpay - Nominal

#### Question 3
```{R}	
eliminateNull <- function(x) { 
  meanX = mean(x,na.rm = TRUE)
  for (i in 1:length(x)){
    if (is.na(x[i])) {
      #print(i)
      x[i] = meanX
    }
  }
  return(x)
}

getmode <- function(v) {
  uniqv <- unique(v)
  uniqv[which.max(tabulate(match(v, uniqv)))]
}

eliminateNullFactor <- function(x) { 
  modeX = getmode(x[!is.na(x)])
  print(modeX)
  for (i in 1:length(x)){
    if (is.na(x[i])) {
      #print(i)
      x[i] = modeX
    }
  }
  return(x)
}


pData$X9Profit = eliminateNull(pcData$X9Profit)
pData$X9Age = eliminateNullFactor(pcData$X9Age)
pData$X9Inc = eliminateNullFactor(pcData$X9Inc)
pData$X9Tenure = eliminateNull(pcData$X9Tenure)
##pData$X0Profit = eliminateNull(pcData$X0Profit)
pData$X9District = eliminateNullFactor(pcData$X9District)
```
###### We started by testing the significance of the missing data to determine whether to exclude those customers with missing data from our analysis. In order to do this, we conducted a t-test. Our null hypothesis is that the missing data on the amount of profit made from customers in the year 2000 is not significant, and our alternative hypothesis is that the missing data signifying the amount of profit Pilgrim Bank’s customers generated for the bank in the year 2000 is significant. The t-test resulted in a p-value of 9.79e-11, which, at a 99% confidence level, is significant; therefore,  we reject the null hypothesis. This indicates that the missing data is significant. According to our data, the median for 1999 profit is $22 per person and the median for 2000 profit is $23 per person.
###### Because the missing data is significant, we need to replace them with proper data. Here, we replaced all the missing data of 1999 Age (X9Age) and 1999 Income (X9Inc) by calculating the mode of these two factors. The mode for 1999 Age is bucket 3, and the mode for 1999 Income is bucket 6. Therefore, we replaced the missing data (NAs) for 1999 Age by bucket 3, and those for 1999 Income by bucket 6. Since it is imperative that we keep track of the missing data for the year 2000, as it signifies whether a customer has left the bank, the 2000 missing data for all columns are left untouched (remained as NA). 
###### Here, we consider replacing all the missing data for 1999 Age, 1999 Income, but not for 1999 Tenure and 1999 District. This is because 1999 Tenure and 1999 District do not have missing data at all.

#### Question 4
######This code generates a density plot that shows the frequency distribution of profit generated from Pilgrim Bank’s customers in 1999. 
```{R}
plot(density(pData$X9Profit), main = "Profitability", xlab = "Profit", ylab = "Frequency")
```

###### The histogram indicates that, just as Green has pointed out, a majority of the profit made by Pilgrim Bank is generated by a small subset of its total customers. A majority of the people are either contributing minimally or generating negative profits for the bank.

###### This code generates a box plot that shows the profits generated by customers in 1999 who use the online banking function compared to those who do not.
```{r}
boxplot(pData$X9Profit~pData$X9Online, xlab = "Online", ylab = "Profit", main = "Online Use and Profitability in 1999")
```

###### The box plot shows that those who use online banking generate a larger range of profits when compared to the customers who do not use the online banking function. Furthermore, those who use the online banking function also show a higher median profitability. This indicates that they may be generating more profit for Pilgrim Bank than those customers who do not use the online banking function. This may be a sign that managers should implement various strategies to encourage the use of the online banking function offered by the bank.

###### This command allows us to create a new column called “SwitchOnline”. This new column showcases whether a customer has switched to online banking from the year 1999 to 2000. A “1” indicates that the customer has switched to online banking from the year 1999 to 2000, a “0” indicates that the customer has not switched their status, and, finally, a “-1” indicates that a customer has stopped using the online banking function offered by Pilgrim Bank.
```{R}
pData$SwitchOnline = pData$X0Online - pData$X9Online
```
###### This command allows us to create a new column titled “ Change In Annual Profit” to illustrate the change in profits between the year 1999 and 2000. 
```{R}
pData$ChangeInAnnualProfit = pData$X0Profit - pData$X9Profit
```
###### This piece of code gives us the summary statistics of the change in annual profit generated by customers who changed their online banking status from no to yes from the year 1999 to 2000. 
```{R}
summary(pData[pData$SwitchOnline== 1,]$ChangeInAnnualProfit)
```
###### This table shows the summary statistics for the change in annual profit for customers who has made the switch to online banking. We can see that the maximum amount of money the bank is making from a single customer is $3,517. The biggest loss in profits experienced by the bank from a single customer is $1,695. On average, the bank makes around $44.38 from its customers.
###### This command gives us the summary statistics of the change in annual profit generated by customers who have no changed their online banking status from 1999 to 2000. 
```{R}
summary(pData[pData$SwitchOnline==0,]$ChangeInAnnualProfit)
```
###### This table shows the summary statistics for the change in annual profit generated for Pilgrim Bank for customers who has not made the switch to online banking. We can see that the maximum amount of money $26,942. The biggest loss experienced by the bank from a single customer is $7,150. On average, the bank makes around $22.86 from its customer. 
###### Overall, when comparing the two summary tables, one showing the change in annual profit for customers who has switched to online banking and another for those who have not made the switch, we see that, on average, customers who use the online banking channel brings in more profits for Pilgrim Bank. Indeed, we see that the bank makes around $44.38 from its customers who have made the switch, which is almost two times the amount of profit made when compared to those who did not make the switch ($22.86).  It has to be noted that, although the customer who has generated the most profit for the bank is one that has not made the switch to online banking ($26,942), in the end, most of the profit from the bank comes from those who have made the switch to the online banking channel. Therefore, in regards to whether Pilgrim Bank should charge fees for the use of their online banking channel or if they should begin offering customer incentives such as rebates and lower service charges in order to promote the use of such a channel, we would suggest lowering services charges to promote the use of such a channel because our analysis suggests that customers who uses the online banking channel brings in more profits for the bank.

#### Question 5
###### This code defines “pData_WithOnline9” as the subset of our Pilgrim Bank dataframe that contains all of the users who use online banking in the year 1999.
```{R}
pData_withOnline9 = pData[pData$X9Online==1,]
```
###### This code defines “pData_withoutOnline9” as the subset of our Pilgrim Bank dataframe that contains all of the users who do not use the online banking feature offered by Pilgrim Bank in the year 1999.
```{R}
pData_withoutOnline9 = pData[pData$X9Online==0,]
```
###### This code allows us to run an independent samples t-test to compare the mean profitability of customers in 1999 based on their online banking status (they either use it or they do not).
```{R}
t.test(pData_withOnline9$X9Profit,pData_withoutOnline9$X9Profit,paired = FALSE)
```
###### For this particular t-test, our null hypothesis is that the mean profitability of customers in 1999 who use the online banking function offered by Pilgrim Bank would be the same as the group of people who do not use the online banking function. Our alternative hypothesis is that the mean profitability of customers in 1999 who use online banking would be different from the mean profitability of customers in 1999 who do not use online banking.
###### With a p-value of 0.225, the difference is insignificant at a 95% confidence level; therefore, we fail to reject the null hypothesis. This suggests that, in 1999, the difference in mean profits brought in by customers who used online banking was not statistically significant when compared to those who did not use the online banking platform.
###### This code defines “pData_withOnline0” as the subset of our Pilgrim Bank dataframe that contains all of the users who use online banking in the year 2000.
```{R}
pData_withOnline0 = pData[pData$X0Online==1,]
```
###### This code defines “pData_withoutOnline0” as the subset of our Pilgrim Bank dataframe that contains all of the users who do not use the online banking feature offered by Pilgrim Bank in the year 2000.
```{R}
pData_withoutOnline0 = pData[pData$X0Online==0,]
```
###### This code allows us to run an independent samples t-test to compare the mean profitability of customers in 2000 based on their online banking status (they either use it or they do not).
```{R}
t.test(pData_withOnline0$X0Profit,pData_withoutOnline0$X0Profit,paired = FALSE)
```
###### For this t-test, our null hypothesis is that the mean profitability of customers in 2000 who use online banking is the same as the mean profitability of customers in 2000 who don’t use online banking. Our alternate hypothesis is that the mean profitability of customers in 2000 who use online banking is not the same as the mean profitability of customers in 2000 who don’t use online banking.
###### The results of this test give us a p-value of 0.0001685. This is much less than 0.01, therefore, we reject the null hypothesis because it is statistically significant at the 1% significance level. In other words, the mean profitability of customers in 2000 who use online banking is not the same as the mean profitability of customers in 2000 who don’t use online banking.
###### This code defines “pData_withEbilling9” as the subset of our Pilgrim Bank dataframe that contains all of the users who use online billpay in the year 1999. 
```{R}
pData_withEbilling9 = pData[pData$X9Billpay == 1,]
```
###### This code defines “pData_withoutEbilling9” as the subset of our Pilgrim Bank dataframe that contains all of the users who do not use online billpay in the year 1999. 
```{R}
pData_withoutEbilling9 = pData[pData$X9Billpay == 0,]
```
###### This code allows us to run an independent samples t-test to compare the mean profitability of customers in 1999  based on whether they use the online billpay function offered by Pilgrim bank.
```{R}
t.test(pData_withEbilling9$X9Profit,pData_withoutEbilling9$X9Profit,paired = FALSE)
```
###### For this t-test, our null hypothesis is that the mean profitability of customers in 1999 who use electronic billpay is the same as the mean profitability of customers in 1999 who don’t use electronic billpay. Our alternate hypothesis is that the mean profitability of customers in 1999 who use electronic billpay is not the same as the mean profitability of customers in 1999 who don’t use electronic billpay.
###### The results of this test give us a p-value of 6.097e-09. This is much less than 0.01, therefore, we reject the null hypothesis because it is statistically significant at the 1% significance level. In other words, the mean profitability of customers in 1999 who use electronic billpay is not the same as the mean profitability of customers in 1999 who don’t use electronic billpay.
###### This code defines “pData_withEbilling0” as the subset of our Pilgrim Bank dataframe that contains all of the users who use online billpay in the year 2000.
```{R}
pData_withEbilling0 = pData[pData$X0Billpay == 1,]
```
###### This code defines “pData_withoutEbilling0” as the subset of our Pilgrim Bank dataframe that contains all of the users who do not use online billpay in the year 2000. 
```{R}
pData_withoutEbilling0 = pData[pData$X0Billpay == 0,]
```
###### This code allows us to run an independent samples t-test to compare the mean profitability of customers in 2000 based on whether they use the online billpay function offered by Pilgrim bank.
```{R}
t.test(pData_withEbilling0$X0Profit,pData_withoutEbilling0$X0Profit,paired = FALSE)
```
###### For this t-test, our null hypothesis is that the mean profitability of customers in 2000 who utilizes the electronic billpay function offered by Pilgrim Bank versus those who do not use the electronic billpay function is the same. Our alternate hypothesis is that the mean profitability of customers in 2000 who utilizes electronic billpay is not the same as the mean profitability of customers in 2000 who don’t use such a platform.
###### The t-test yielded a p-value of 2.044e-11; therefore, we reject the null hypothesis because the p-value is statistically significant at a 99% confidence level. This signifies that the mean profitability of customers in 2000 who use the electronic billpay function is not the same as the mean profitability of of customers in 2000 who do not use such a platform.

#### Question 6
###### The block of code below generates a transition matrix for customers’ 1999 and 2000 enrollment status in online banking & electronic billpay.
```{R}	
pData$X9Type = "0"
pData[pData$X9Online==0 & pData$X9Billpay == 0,]$X9Type = "1" 
pData[pData$X9Online==1 & pData$X9Billpay == 0,]$X9Type = "2" 
pData[pData$X9Online==1 & pData$X9Billpay == 1,]$X9Type = "3" 

pData$X0Type = "0"
pData[!is.na(pData$X0Online) & !is.na(pData$X0Billpay) & pData$X0Online==0 & pData$X0Billpay == 0,]$X0Type = "1" 
pData[!is.na(pData$X0Online) & !is.na(pData$X0Billpay) & pData$X0Online==1 & pData$X0Billpay == 0,]$X0Type = "2" 
pData[!is.na(pData$X0Online) & !is.na(pData$X0Billpay) & pData$X0Online==1 & pData$X0Billpay == 1,]$X0Type = "3" 
pData[is.na(pData$X0Online) & is.na(pData$X0Billpay),]$X0Type = "4" 

##pData[pData$X0Type == 0,]$ID

table<-table(pData$X9Type,pData$X0Type)
margin.x = table[,1]+table[,2]+table[,3]+table[,4]+table[,5]
table = cbind(table,margin.x) 
table2 = table 
table2[,1] = table[,1]/table[,6] 
table2[,2] = table[,2]/table[,6] 
table2[,3] = table[,3]/table[,6] 
table2[,4] = table[,4]/table[,6] 
table2[,5] = table[,5]/table[,6] 
table2[,6] = table[,6]/table[,6] 


round(table2,2)
```
###### The rows of the table represents the customers’ 1999 enrollment status in online banking & electronic billpay and the columns of the table represents the customers’ 2000 enrollment status in online banking & electronic billpay.
###### First, two new columns, X9Type and X0Type, are added to our dataframe pData to categorize each customer into his or her respective enrollment type in the year 1999 and 2000. Type 1 (Row 1) indicates that the customer did not use online banking or electronic billpay in the year 1999. Type 2 (Row 2) indicates that the customer used online banking but did not use electronic billpay in the year 1999. Type 3 (Row 3) indicates that the customer used both online banking and electronic billpay in 1999. Similarly,  Type 1 (Column 1) indicates that the customer did not use online banking or electronic billpay in 2000. Type 2 (Column 2) indicates that the customer used the online banking format but did not use electronic billpay in 2000. Type 3 (Column 3) indicates that the customer used both online banking and electronic billpay in 2000. In addition, there are two more types in 2000 than in 1999, which is type 0 and Type 4. Type 0 (Column 0) indicates that the customer used the electronic billpay platform but did not use online banking. Since this type of customer does not exist in 1999, there is no row called Type 0 in our pivot table. Type 4 (Column 4) indicates that the customer in 1999 left the bank in the year 2000. Because there are NAs existed in the data of 2000, which means that the customer left the bank in 2000, these customers who have data with NAs in online and billpay at the same time are accounted into Type 4. Because there is no NAs existed in the data of 1999, there is no row called Type 4 in our pivot table.  Looking at the table, we see that customers under Type 1 (who did not use online banking and did not use electronic billpay in 1999) are the most likely to leave the bank in 2000. This is because among all the types in 1999 under the probability under Type 4 in 2000 ( from the column), Type 1 has the greatest probability, which is 0.17. There is not much of a difference in the likelihood of leaving the bank for those customers who used online banking in 1999 and those who used online banking and electronic billpay in 1999. In other words, utilizing the electronic billpay aspect of the bank in 1999, in addition to the online banking channel in 1999, does not make a significant difference in whether or not the customer will leave the bank in 2000.

#### Question 7
```{R}
getRetention <- function(x,y) {
  z = c(1:length(x))
  for (i in 1: length(x)) {
    if (!is.na(y[i])) {
      z[i] = 1
    } else {
      z[i] = 0
    }
  }
  return (z)
}

pData$Retention = getRetention(pcData$X9Online,pcData$X0Online)
```
###### This block of code generates two regressions. The first is for profit and the second is for retention.
```{R}	
modelProfit <- lm(pData$X9Profit~pData$X9Online+pData$X9Billpay) 
summary(modelProfit)

modelRetention <- lm(pData$Retention~pData$X9Online+pData$X9Billpay)
summary(modelRetention) 
```
###### The dependent variable of this regression is customer profitability in 1999. The independent variables of this regression are binary variables called online channel and electronic billpay. The variable online has a value of 1 if the customer uses the online channel and a value of 0 otherwise. The variable electronic billpay has a value of 1 if the customer has electronic billpay and a value of 0 otherwise. The amount of profit generated by a single customer who does not have the online channel or electronic billpay is about $110.79, which is also the intercept of the regression. The amount of profit generated by a single customer who has the online channel and electronic billpay is equal to $110.786 - $6.619 + $91.240 or about $195.41. The coefficient $\beta_1$ on online channel shows that going from not using the online channel to using it decreases the profitability by about $6.62 per customer, holding other variables constant. The coefficient $\beta_2$ on billpay shows that going from not having electronic billpay to having it increases the profitability by about $91.24 per customer, holding other variables constant. The p-value (3.843e-12) for the F-test indicates that the regression that was generated is a good model. However, the p-value for the X9Online coefficient is 0.186, which means that online banking is statistically insignificant when it comes to profitability. The p-value for the X9Billpay coefficient is 0.925e-13, indicating that electronic billpay is statistically significant at the 1% significance level, when it comes to customer profitability. The R-squared value of 0.001661, which is very small, indicates that only 0.1661% of the variation in profit can be explained by the variations in the online channel and electronic billpay. The adjusted R-squared value of 0.001597 indicates that 0.1597% of the variation can be explained by only the independent variables, which are online channel and electronic billpay, that actually affect the dependent variable retention.
###### The dependent variable of this regression is retention. This variable has a value of 1 if the customer stays in Pilgrim Bank and a value of 0 otherwise. The independent variables are dummy variables called the online channel and electronic billpay. Variable online channel has a value of 1 if the customer uses online channel and a value of 0 otherwise. Variable electronic billpay has a value of 1 if the customer has electronic billpay and a value of 0 otherwise. Here, we discuss under the situation when X9Online is 0 or 1. The coefficient $\beta_1$ on online channel shows that going from not using the online channel system to using it increases the retention rate by 0.028106 per customer, holding other variables constant. The coefficient $\beta_2$ on billpay shows that going from not having electronic billpay to having it decreases the retention rate by 0.011407 per customer, holding other variables constant. The p-value (0.0001403) for the F-test indicates that the regression that was generated is a good model. However, the p-value for the X9Online coefficient is 3.67e-05, which means that online banking is statistically significant when it comes to retention. However, the p-value for the X9Billpay coefficient is 0.512, indicating that electronic billpay is statistically insignificant when it comes to customer retention. The R-squared value of 0.0005608, which is small, indicates that 0.05608% of the variation in retention can be explained by the variation in online channel and electronic billpay. The adjusted R-squared value of 0.0004976 indicates that 0.04976% of variation can be explained by only the independent variables, which are online channel and electronic billpay, that actually affect the dependent variable retention.

#### Question 8
######Omitted variable bias is when there are variables that are not included in the regression (are in the error term) which causes bias in the estimator. This occurs when the omitted variable is correlated with another independent variable in the regression and is a determinant of the dependent variable. It should be mentioned that it is due to the inevitable occurrence of omitted variable biases that causation is so difficult to determine. It must also be noted that there are unmeasurable and unobservable variables that are not included in the regression which cause omitted variable bias as well.
###### To try and eliminate some of the bias, we have created about 30 multiple regressions, including 2 with an interaction term and 1 with a logarithm. Looking at the results of the regressions with interactions and log will allow us to see whether a nonlinear model is a “better fit” than a linear one. By adding in additional regressors in these regressions, we can try to eliminate some bias in the estimator. For example, when interpreting the coefficients on an independent variable, such as online, we would be able to control for the effects of other variables as we would be holding all other variables (included in the regression) constant. 
###### In the case of Pilgrim Bank, each time a regressor is added to the regression, the R-squared value will increase even if the newly added variable does not help explain the variation in profit. Therefore, examining the value of the adjusted R-squared value is imperative because it takes into account the addition of independent variables. Alternatively, we can also use BIC, Bayesian information criterion, or AIC, Akaike information criterion. To determine which model is the “best fit” for the data we have at hand, the regression should have the highest adjusted R-squared value, or the lowest BIC or AIC. BIC has the strictest penalty to compensate for adding more regressors so it is the best criterion to use when determining the regression model with the best fit.
```{R}
## Interaction between X9Age and X9Income --> to show that perhaps nonlinear relationship is better fit of data
model6 <- lm(X9Profit~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9District)+factor(X9Billpay)+(factor(X9Age)*factor(X9Inc)),data = pData)
summary(model6)
## R-squared = 0.07126
## Adjusted R-squared = 0.06929
BIC(model6)
## BIC = 443011.7
AIC(model6)
## AIC = 442434.7
```
###### The dependent variable of this regression is customer profitability in 1999. The independent variables of this regression are online, age, income, tenure, district, billpay, and an interaction term called age x income. The coefficient on online shows that going from not using the online banking system to using it increases the profitability by about $3.71 per customer, holding all other factors constant. This means that we are controlling for age, income, tenure, district, billpay, and age x income. However, with a p-value of 0.4488, this increase in profitability is not statistically significant even at the 10% significance level. The R-squared value of 0.07126 indicates that merely 7.126% of the variation in profit can be explained by the variation in the independent variables.
```{R}
model9 <- lm(X9Profit~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9District)+factor(X9Billpay),data = pData)
summary(model9)
## R-squared = 0.06798
## Adjusted R-squared = 0.06742
BIC(model9)
## BIC = 442625.8
AIC(model9)
## AIC = 442450.2
```
###### The dependent variable of this regression is customer profitability in 1999. The independent variables of this regression are online, age, income, tenure, district, and billpay. The coefficient of online shows that going from not using the online banking system to using it increases the profitability by about $3.99 per customer, holding all other factors constant. This means that we are controlling for age, income, tenure, district, and billpay. However, with a p-value of 0.41519, this increase in profitability is not statistically significant even at the 10% significance level. The R-squared value of 0.06798 indicates that 6.798% of the variation in profit can be explained by the variation in the independent variables.
```{R}
model10 <- lm(X9Profit~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9Billpay),data = pData)
summary(model10)
## R-squared = 0.06739
## Adjusted R-squared = 0.06689
BIC(model10)
## BIC = 442625.1
AIC(model10)
## AIC = 442466.2
```
###### The dependent variable of this regression is customer profitability in 1999. The independent variables of this regression are online, age, income, tenure, and billpay. The coefficient on online shows that going from not using the online banking system to using it increases the profitability by about $4.72 per customer, holding all other factors constant. This means that we are controlling for age, income, tenure, and billpay. However, with a p-value of 0.33479, this increase in profitability is not statistically significant even at the 10% significance level. The R-squared value of 0.06739 indicates that 6.739% of the variation in profit can be explained by the variation in the independent variables.
###### These are the three regression models that we have chosen, from the many we originally ran, as the best fitting models for the data. We started off by adding additional regressors one-by-one to the model10 regression, the regression we originally started with. We then also tried adding some interaction terms, logs, and polynomials. We narrowed it down to these three after comparing all of the adjusted R-squared, BIC, and AIC values. We chose regression model6 because it has the highest adjusted R-squared value and the lowest AIC value. We chose regression model9 because it has the third highest adjusted R-squared value, the second lowest BIC value, and the second lowest AIC value. We chose regression model10 because it has the lowest BIC value and the third lowest AIC value.
```{R}
# Set seed
set.seed(42)
# Shuffle row indices: rows
rows <- sample(nrow(pData))
# Randomly order data
pDataRandom <- pData[rows, ]
# Determine row to split on: split
split <- round(nrow(pDataRandom) * .80)
# Create train
train <- pDataRandom[1:split, ]
# Create test
test <- pDataRandom[(split + 1):nrow(pDataRandom), ]

model9 <- lm(X9Profit~factor(X9Online)+factor(X9Inc)+X9Tenure+factor(X9Age)+factor(X9Billpay)+factor(X9District),data = train)
pred1 <- predict(model9, test)

# Compute errors: error
error1 <- pred1 - test$X9Profit
#Omit NA
#error <-error <- error[!is.na(error)]
# Calculate RMSE
sqrt(mean(error1^2))

model10 <- lm(X9Profit~factor(X9Online)+factor(X9Inc)+X9Tenure+factor(X9Age)+factor(X9Billpay),data = train)
pred2 <- predict(model10, test)

# Compute errors: error
error2 <- pred2 - test$X9Profit
#Omit NA
#error <-error <- error[!is.na(error)]
# Calculate RMSE
sqrt(mean(error2^2))

model6 <- lm(X9Profit~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9District)+factor(X9Billpay)+(factor(X9Age)*factor(X9Inc)),data = pData)
pred3 <- predict(model6, test)

# Compute errors: error
error3 <- pred3 - test$X9Profit
#Omit NA
#error <-error <- error[!is.na(error)]
# Calculate RMSE
sqrt(mean(error3^2))
```
###### To prevent overfitting, we decided to separate our data into a training set and a validation set. We ran our top three regressions again with the data that has just been split. We then used the validation set to evaluate our three regressions to see which one best fits our data. To arrive at a conclusion with our cross-validation test, we calculated and looked at the root-mean-square-error (RMSE). With an RMSE value of 275.11, we have validated the fact that model6 is our best-fitting regression model when compared to model9 (RMSE value of 275.94) and when compared to model10 (RMSE value of 276.05).
```{R}
#Creates a new data frame that stores all the criterions used to compare the best three models chosen for retention 
Results = data.frame(ModelName = c("Model6R", "Model9R","Model10R"), AIC = c(22256.28, 23378.42,23389.35), BIC = c(22833.25,23554.02,23548.02), AdjustedR = c(0.143,0.111,0.110), RMSE = c(309.2696,309.2705,309.2706))
Results
```
###### In an attempt to find the best model for retention, the same variables used for the regressions to fit customer profitability in 1999 were used for model6retention, model9retention, and model10retention. For the regression titled “model6retention”, the dependent variable is customer retention in 1999 and the independent variables are online, age, income, tenure, district, billpay, and an interaction term called age*income. For the regression titled “model9retention”, the dependent variable is customer retention in 1999 while the independent variables are online, age, income, tenure, district, and billpay. For the last regression titled “model10retention”, the dependent variable is again customer retention in 1999 and the independent variables are online, age, income, tenure, and billpay. After comparing the AIC, BIC, and adjusted R-squared of the three models, respectively, we see that model6retention has the lowest AIC and BIC while maintaining the highest adjusted R-squared value out of the three models we have chosen. Furthermore, after conducting a cross-validation test, we see that model6retention returned the lowest RMSE value.

#### Question 9
```{R}
#Predict the 2000
modelBest <- lm(Retention~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9District)+factor(X9Billpay)+(factor(X9Age)*factor(X9Inc)),data = pData)

p <-predict(modelBest,pData)
summary(p)
mean(pData$Retention)

error <- p - pData$Retention
sqrt(mean(error^2))
```
###### Using the regression model that we have determined to fit our data best (model6retention, renamed as modelBest), we predicted customer retention for the year 2000. Looking at our prediction summary, we see that the range of customers retained is predicted to be from about 57.6% to 100% (The actual maximum retention rate computed was 107.73% but it would not make sense for retention to be over 100%). The predicted retention for 2000 has an RMSE of 0.343. This means that our model has an average prediction error of 34.3%.

#### Question 10
```{R}
#Predict the 2000 using the model we have determined to be the best fit (model6, now renamed as modelBest).
modelBest <- lm(X9Profit~factor(X9Online)+factor(X9Age)+factor(X9Inc)+X9Tenure+factor(X9District)+factor(X9Billpay)+(factor(X9Age)*factor(X9Inc)),data = pData)
#creating a new data frame for our predictive analysis
ID = pData$ID
X0Profit = pData$X0Profit
X9Online = pData$X0Online
X9Age = pData$X9Age
X9Inc = pData$X9Inc
X9Tenure = pData$X9Tenure
X9District = pData$X9District
X9Billpay = pData$X0Billpay
Data2000 = data.frame(ID, X0Profit, X9Online,X9Age,X9Inc,X9Tenure,X9District,X9Billpay,X9Age*X9Inc)

#Making sure we only use the data from customers who remained with the bank in 2000 
Data2000 = Data2000[pData$Retention == 1,]

p <-predict(modelBest,Data2000)
summary(p)

#The actual profitability per customer in 2000 
mean(Data2000$X0Profit[!is.na(Data2000$X0Profit)])

#Calculating RMSE
err <- p - Data2000$X0Profit
sqrt(mean(err[!is.na(err)]^2))

#Calculating Relative Error 
err <- (p - Data2000$X0Profit)/Data2000$X0Profit
sqrt(mean(err[!is.na(err) & err < Inf & err > -Inf]^2))
```
###### In order to use the same regression model from 1999, we are assuming that customers live in the same district and are in the same age and income groups as the previous year. Looking at our summary for the predicted 2000 profitability, the average predicted profitability for 2000 is $118.89. The actual average profitability profitability for the year 2000 is $144.83. Our predicted value for average profitability for 2000 is $25.94 lower than that for the actual profitability for 2000. Looking at the RMSE, the predicted customer profitability for the bank in the year 2000 was off by $383.15 per customer. Looking at the relative error, our model was off by an average of 16.25% when predicting the profitability of each customer in the year 2000.

#### Question 11
```{R}
p <-predict(modelBest,pData,se.fit = TRUE)
names(p)
#First 6 customers 
head(cbind(p$fit,p$se.fit))
#Last 6 customers (total customers = 31634)
tail(cbind(p$fit,p$se.fit))
```
###### The codes above returns the standard errors in the predicted profitability of each customer. The “head” and “tail” functions allows us to view the standard errors of the first and last six customers of Pilgrim Bank.
```{R}
lower = pData$X0Profit - qnorm(0.975)*p$se.fit
higher = pData$X0Profit + qnorm(0.975)*p$se.fit
conf.int = data.frame(lower,higher)

# The command “View(conf.int)” allows us to view the 95% confidence interval for all 31,634 customers (NA indicates that the customer has left the bank the year 2000).

#The summary function allows us to see the summary statistics for the lower and upper limits of the confidence intervals.
summary(conf.int$lower)
summary(conf.int$higher)
```
###### The code above allows us to construct 95% confidence intervals for all individual customers, which indicates that we are 95% certain that the true mean profitability of each customer falls within the lower and upper limit that we have calculated for each of them. If you were to view the confidence intervals constructed for each customer of Pilgrim Bank (View(conf.int)), you will see that some of the confidence intervals are in the negatives, which indicates that the customer generates negative profits for the bank. Looking at the summary statistics for the lower and upper limits of the confidence intervals for all 31,634 customers combined, we can say with 95% confidence that the mean profitability generated by a single customer falls between $122.77 and $166.89. It has to be noted, though, that the range for the upper and lower limits of the 95% confidence intervals constructed for the 31,634 customers is very large. This may be because, as we have seen earlier, a small segment of Pilgrim Bank’s total customers generates most of the profits for the bank. It should also be noted that the district, tenure, income, and age of a customer may all play a role in affecting the amount of profits contributed by each customer.
```{R}
#Second confidence interval for total profits across customers 
totalLower = sum(conf.int[!is.na(conf.int$lower),]$lower)
totalLower
totalHigher = sum(conf.int[!is.na(conf.int$higher),]$higher)
totalHigher
```
###### The 95% confidence interval for total profits across customers was computed by adding all the individual customers’ lower and upper limits together (their individual 95% profit confidence interval). We are 95% certain that the true mean profitability of the bank lies between 3,240,589 and 4,405,119.

#### Question 12
###### To conclude, we can see that there is a positive correlation between the amount of profit and the usage of Pilgrim Bank’s online banking platform. We can also see that customers who did not use the online banking platform nor the electronic billpay service in 1999 were the most likely to leave the bank in the year 2000. However, we cannot establish a causal relationship between profit and the use of the bank’s online banking feature since there are most definitely factors that we have not and cannot control for. Ultimately, what we can conclude is that there is, indeed, a positive relationship between profitability, retention and online banking usage. Therefore, in order to generate more profit, Pilgrim Bank needs to improve the prevalence of online usage among its customers in order to drive profitability.
###### Seeing that we do not know the exact cost to setup a more complete online channel for all of Pilgrim Bank’s customers, it might be best for Pilgrim Bank to focus on providing free online service to a selection of its customers and slowly move towards providing a more inclusive online service in the future in order to promote the use of such a platform. Perhaps Pilgrim Bank should look at those customers who are most likely to leave the bank, namely those who do not use the online banking channel or the electronic billpay service in 1999, to determine who should receive free online services. Those customers could be offered a free trial in an attempt to retain this type of customer, which will ultimately lead to more profits. Another suggestion would be for Pilgrim Bank to focus on its high profitability customers as they generate the most profits for Pilgrim Bank and are thus the most important individuals to attempt to retain. All in all, the online banking platform is and can continue to be a key factor in generating profits for Pilgrim Bank. 





